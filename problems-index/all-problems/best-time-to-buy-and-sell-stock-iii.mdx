---
title: '❗️ Best Time to Buy and Sell Stock III'
description: '[leetcode link](https://leetcode.com/problems/best-time-to-buy-and-sell-stock-iii/description/)'
mode: 'wide'
---
<Tabs>
  <Tab title="Question" icon="circle-question" iconType="regular">
    <Card>
      <p>You are given an array <code>prices</code> where <code>prices[i]</code> is the price of a given stock on the <code>i<sup>th</sup></code> day.</p>  <p>Find the maximum profit you can achieve. You may complete <strong>at most two transactions</strong>.</p>  <p><strong>Note:</strong> You may not engage in multiple transactions simultaneously (i.e., you must sell the stock before you buy again).</p>   <p><strong class="example">Example 1:</strong></p>   <strong>Input:</strong> prices = [3,3,5,0,0,3,1,4] <br/> <strong>Output:</strong> 6 <br/> <strong>Explanation:</strong> Buy on day 4 (price = 0) and sell on day 6 (price = 3), profit = 3-0 = 3. Then buy on day 7 (price = 1) and sell on day 8 (price = 4), profit = 4-1 = 3.  <p><strong class="example">Example 2:</strong></p>   <strong>Input:</strong> prices = [1,2,3,4,5] <br/> <strong>Output:</strong> 4 <br/> <strong>Explanation:</strong> Buy on day 1 (price = 1) and sell on day 5 (price = 5), profit = 5-1 = 4. Note that you cannot buy on day 1, buy on day 2 and sell them later, as you are engaging multiple transactions at the same time. You must sell before buying again.   <p><strong class="example">Example 3:</strong></p>   <strong>Input:</strong> prices = [7,6,4,3,1] <br/> <strong>Output:</strong> 0 <br/> <strong>Explanation:</strong> In this case, no transaction is done, i.e. max profit = 0.    <p><strong>Constraints:</strong></p>  <ul>  <li><code>1 &lt;= prices.length &lt;= 10<sup>5</sup></code></li>  <li><code>0 &lt;= prices[i] &lt;= 10<sup>5</sup></code></li> </ul> 
    </Card>
  </Tab>
  <Tab title="Solution" icon="lightbulb" iconType="regular" >
    <Card>
        Similar to 1 txn question, we do the same thing, but keep track of 2 txns, and cost of second txn is the most important calculation.
  Cost of second txn is the crucial definition.
	
	For first txn, cost was calculated as buy price (cost that will eventually get deducted). 
	So, for second txn, t2_cost is the cost that will eventually get deducted for 2nd txn profit calculation, so this cost should have the profit from 1st txn negated, as it is actually credit. 
	
	So eventually, when t2_cost is deducted to calculate the second txn's profit, the 1st txn's profit will eventually be contributing to the profit. 
	
	t2 profit = price - t2cost
	               = price_2 - ( price_1 - t1_profit )
								 = t1_profit - price1 - price2
	
   #minimum cost of first transaction up to current price (p)
        t1_cost = [t1_cost, p].min
		
		# maximum profit possible from first transaction, aka biggest difference 
		# between seen prices and minimum price (t1_cost) up to current price (p)
        t1_profit = [t1_profit, p - t1_cost].max 
		
		# treating t1_profit as the maximum credit possible from a *completed* first 
		# transaction towards purchasing the second transaction, the true cost(deduction that should happend) of the 
		# second transacton would then be the current price minus that credit. We track
		# the price that would result in the minimum *true cost* of the second transaction.
        t2_cost = [t2_cost, p - t1_profit].min 
		
		# as explained above, t2_cost accounts for the profit from the first transaction and
		# is the *true cost* of the second transaction, so the *true profit* of the second 
		# transaction would be the current price (p) minus t2_cost
        t2_profit = [t2_profit, p - t2_cost].max 
    </Card>
  <Expandable title="code">
    <CodeGroup dropdown>
```ruby title="Best Time to Buy and Sell Stock III" lines
# @param {Integer[]} prices
# @return {Integer}
def max_profit(prices)
  prices.reduce([prices.first, 0 , Float::INFINITY, 0]) {|(t1_cost, t1_profit, t2_cost, t2_profit) , price|
    [
        [t1_cost, price].min,
        [t1_profit, price - t1_cost].max,
        [t2_cost, price - t1_profit].min,
        [t2_profit, price - t2_cost].max
    ]
  }.last
end
```
    </CodeGroup>
  </Expandable>
  </Tab>
</Tabs>